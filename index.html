  <!doctype html>
  <html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta user-scalable="no" name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no" />
    <title>PDF Viewer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: grid;
        grid-template-columns: auto 1fr;
        height: 100vh;
        background-color: #525252;
      }

      #pdf-viewer-container {
        height: 100vh;
        overflow: auto;
        background-color: #525252;
        display: flex;
        flex: 1;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }

      #fileListContainer {
        height: 100%;
        background-color: #151515;
        color: #858585;
        overflow-y: auto;
        z-index: 10;
        width: 4.167vw;
        display: flex;
        flex-direction: column;
        padding-top: 0.833vw;
        position: absolute;
        right: 0px;
      }

      .page {
        margin-bottom: 10px;
        display: block;
        transition: transform 0.3s ease;
      }

      .sidebar {
        height: 94vh;
        margin-top: 2vh;
        margin-left: 1.2vw;
        background-color: #151515;
        color: #858585;
        overflow-y: auto;
        z-index: 10;
        width: 5.5vw;
        display: flex;
        flex-direction: column;
        padding-top: 0.833vw;
        border-radius: 0.5rem;
      }

      .zoom-button, .blank-page-button {
        margin: 0.417vw auto;
        display: block;
        cursor: pointer;
        font-size: 0.75vw;
        padding: 0.417vw;
        width: 3.333vw;
        background-color: #444;
        border: none;
        color: #adadad;
        border-radius: 0.21vw;
      }

      .zoom-button:hover, .blank-page-button:hover {
        background-color: #555;
        color: white;
      }

      .zoom-level-button {
        margin-left: 0.417vw auto;
        display: block;
        cursor: pointer;
        font-size: 0.75vw;
        padding: 0;
        width: 4.167vw;
        background-color: #151515;
        border: none;
        color: #adadad;
        border-radius: 0px;
      }

      #zoom-level {
        text-align: center;
        margin: 0.417vw 0;
        color: #ccc;
        font-size: 0.667vw;
      }

      #fileList {
        margin: 20px 0;
        padding: 0;
        list-style: none;
      }

      #fileList li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }

      #fileList li:hover {
        background-color: #f5f5f5;
      }

      .loading {
        color: white;
        font-size: 1vw;
        margin-top: 1.667vw;
      }

      .blank-page {
        background-color: white;
        border: 1px solid #ccc;
      }
    </style>
  </head>

  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <button class="zoom-button" id="zoomIn">+</button>
      <button class="zoom-level-button" id="zoom-level">100%</button>
      <button class="zoom-button" id="zoomOut">-</button>
      <button class="blank-page-button" id="addBlankPage">Add Page</button>

      <button id="signInButton">Sign in with Google</button>
      <button id="signOutButton">Sign Out</button>
      <button id="loadFolderButton">Load Files</button>
    </div>
    <!-- File List Container -->
    <div id="fileListContainer" class="hidden">
      <h2>PDF Files</h2>
      <ul id="fileList"></ul>
    </div>
    <!-- PDF Viewer Container -->
    <div id="pdf-viewer-container">
      <div class="loading">Loading File...</div>
    </div>
    <!-- Load the Google API client library,Google Identity Services library, PDF.js libraru -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <script>
      // [Previous Drive/Google API Configuration code remains the same]

      // PDF Viewer

      const viewerContainer = document.getElementById("pdf-viewer-container");
      const zoomInButton = document.getElementById("zoomIn");
      const zoomOutButton = document.getElementById("zoomOut");
      const zoomLevelDisplay = document.getElementById("zoom-level");
      const addBlankPageButton = document.getElementById("addBlankPage");
      let pdfDoc = null;
      let zoom = 1; // Default zoom level
      let renderedPages = [];

      // Constants for page dimensions
      const A4_WIDTH = 595;  // Points (approximate width of A4 page)
      const A4_HEIGHT = 842; // Points (approximate height of A4 page)

      // Add Blank Page Function
      function addBlankPage() {
        // If no PDF is loaded, create a new blank canvas
        if (!pdfDoc) {
          createBlankDocument();
          return;
        }

        // If PDF is loaded, add a blank page
        addBlankCanvas();
      }

      // Create a completely new blank document
      function createBlankDocument() {
        // Clear viewer container
        viewerContainer.innerHTML = '';
        renderedPages = [];

        // Create a blank canvas
        addBlankCanvas();
      }

      // Create a blank canvas
      function addBlankCanvas() {
        // Create a canvas for the blank page
        const canvas = document.createElement("canvas");
        canvas.classList.add("page", "blank-page");

        // Set canvas size
        canvas.width = A4_WIDTH;
        canvas.height = A4_HEIGHT;

        // Apply current zoom
        canvas.style.width = `${A4_WIDTH * zoom}px`;
        canvas.style.height = `${A4_HEIGHT * zoom}px`;

        // Get 2D context and fill with white
        const context = canvas.getContext("2d");
        context.fillStyle = "white";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // Add some light grid lines to make it look like a blank page
        context.strokeStyle = "#e0e0e0";
        context.lineWidth = 0.5;

        // Horizontal lines
        for (let y = 50; y < canvas.height; y += 50) {
          context.beginPath();
          context.moveTo(0, y);
          context.lineTo(canvas.width, y);
          context.stroke();
        }

        // Vertical lines
        for (let x = 50; x < canvas.width; x += 50) {
          context.beginPath();
          context.moveTo(x, 0);
          context.lineTo(x, canvas.height);
          context.stroke();
        }

        // Append the blank page to the viewer
        viewerContainer.appendChild(canvas);

        // Add to renderedPages array
        renderedPages.push({pageNum: renderedPages.length + 1, canvas});

        // Update zoom to apply current zoom settings
        updateZoom(0);
      }

      // Existing code for loading PDF and rendering pages remains the same
      // Load PDF
      function loadPdf(data) {
        pdfjsLib.getDocument({
          data: data,
          // Add these options for more forgiving parsing
          cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/cmaps/',
          cMapPacked: true,
          disableRange: true,
          disableStream: true,
          disableAutoFetch: true,
          isEvalSupported: false
        }).promise
          .then(function(pdf) {
            pdfDoc = pdf;
            renderAllPages();
          })
          .catch(function(error) {
            console.error("Error loading PDF: ", error);
            viewerContainer.innerHTML = '<div class="loading">Error loading PDF: ' + error.message + '</div>';
          });
      }

      // render all pages
      function renderAllPages() {
        viewerContainer.innerHTML = ""; // clear all viewer containers
        renderedPages = [];

        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
          renderPage(pageNum); // 1by1 render each page
        }
      }

      //render a single page
      function renderPage(pageNum) {
        pdfDoc.getPage(pageNum).then(function (page) {
          const viewport = page.getViewport({scale: zoom}); // apply zoom scale
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.classList.add("page");
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          const renderContext = {
            canvasContext: context,
            viewport: viewport,
          };

          page
            .render(renderContext)
            .promise.then(function () {
              // Append the rendered page to the viewer container
              viewerContainer.appendChild(canvas);
              renderedPages.push({pageNum, canvas}); // Save the rendered page and canvas
            })
            .catch(function (error) {
              console.error("Error rendering page " + pageNum + ": " + error);
            });
        });
      }

      function setZoom(n) {
        zoom = n;
        updateZoom(0);
      }

      // update zoom
      function updateZoom(factor) {
        zoom += factor; // update zoom
        renderedPages.forEach(({canvas}, index) => {
          zoomLevelDisplay.textContent = `${Math.round(zoom * 100)}%`;

          const scale = zoom;

          // smooth transition for transform & marginTop
          canvas.style.transition =
            "width 0.2s ease, height 0.2s ease, margin 0.2s ease";

          // adjust the canvas size based on the zoom factor
          const originalWidth = canvas.width;
          const originalHeight = canvas.height;

          canvas.style.width = `${originalWidth * scale}px`;
          canvas.style.height = `${originalHeight * scale}px`;

          // adjust the spacing between pages
          canvas.style.marginTop = `${scale * 10}px`;
        });
      }

      // Modify downloadPdf function to reset pdfDoc when a new file is loaded
      async function downloadPdf(fileId) {
        try {
          // Show loading indicator
          viewerContainer.innerHTML = '<div class="loading">Loading File...</div>';

          // Use fetch with the access token instead of gapi.client.drive.files.get
          const accessToken = gapi.auth.getToken().access_token;
          const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // Get the PDF as an ArrayBuffer
          const arrayBuffer = await response.arrayBuffer();

          // Load the PDF directly with the ArrayBuffer
          pdfjsLib.getDocument({data: arrayBuffer}).promise
            .then(function(pdf) {
              pdfDoc = pdf;
              renderAllPages();
            })
            .catch(function(error) {
              console.error("Error loading PDF: ", error);
              viewerContainer.innerHTML = '<div class="loading">Error loading PDF: ' + error.message + '</div>';
            });
        } catch (error) {
          console.error('Error downloading file:', error);
          viewerContainer.innerHTML = '<div class="loading">Error loading PDF: ' + error.message + '</div>';
        }
      }

      // Add event listener for Add Blank Page button
      addBlankPageButton.addEventListener("click", addBlankPage);

      // Existing zoom event listeners
      zoomInButton.addEventListener("click", () => {
        console.log("Zoom In clicked");
        updateZoom(0.05); // Zoom in by 10%
      });

      zoomInButton.addEventListener("click", () => updateZoom(0.1));
      zoomOutButton.addEventListener("click", () => updateZoom(-0.1));
      zoomLevelDisplay.addEventListener("click", () => setZoom(1));

      // Keyboard shortcuts
      document.addEventListener("keydown", function (event) {
        if (event.ctrlKey) {
          if (event.key === "+" || event.key === "=") {
            event.preventDefault();
            updateZoom(0.1);
          } else if (event.key === "-") {
            event.preventDefault();
            updateZoom(-0.1);
          } else if (event.key === "0") {
            event.preventDefault();
            zoom = 1;
            updateZoom(0);
          }
        }
      });

      // Initial setup
      function initializeViewer() {
        // Clear any existing content
        viewerContainer.innerHTML = '';
        renderedPages = [];
        pdfDoc = null;

        // Create initial blank page
        createBlankDocument();
      }

      // Call initialization on page load
      initializeViewer();

      // [Rest of the existing script remains the same]
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>

  </html>